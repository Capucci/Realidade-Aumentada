import { MindARThree } from "mind-ar/dist/mindar-image-three.prod.js";
import * as THREE from "three";
import { GLTFLoader } from "three/examples/jsm/loaders/GLTFLoader.js";
import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";
import { TransformControls } from "three/examples/jsm/controls/TransformControls.js";

document.addEventListener("DOMContentLoaded", () => {
  const mindarThree = new MindARThree({
    container: document.body,
    imageTargetSrc: "./targets.mind"
  });

  const { renderer, scene, camera } = mindarThree;

  // Luz bÃ¡sica
  const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
  scene.add(light);

  // Anchor real do target
  const anchor = mindarThree.addAnchor(0);

  // OrbitControls sÃ³ para navegaÃ§Ã£o no preview
  const orbitControls = new OrbitControls(camera, renderer.domElement);
  orbitControls.enableDamping = true;

  // Loader do GLB
  const loader = new GLTFLoader();
  loader.load("./model.glb", (gltf) => {
    const model = gltf.scene;
    model.scale.set(0.2, 0.2, 0.2);
    model.position.set(0, 0, 0);

    // Modelo no target real
    anchor.group.add(model);

    // ğŸ”¹ Modelo "fake preview" para ajuste
    const previewModel = model.clone();
    previewModel.position.set(0, 0, -1); // 1 metro na frente da cÃ¢mera
    scene.add(previewModel);

    // TransformControls no modelo fake
    const transformControls = new TransformControls(camera, renderer.domElement);
    transformControls.attach(previewModel);
    scene.add(transformControls);

    // Bloqueia Orbit quando usando TransformControls
    transformControls.addEventListener("dragging-changed", (event) => {
      orbitControls.enabled = !event.value;
    });

    // Alterna modo: tecla 1 = mover, 2 = girar, 3 = escalar
    window.addEventListener("keydown", (event) => {
      switch (event.key) {
        case "1":
          transformControls.setMode("translate");
          break;
        case "2":
          transformControls.setMode("rotate");
          break;
        case "3":
          transformControls.setMode("scale");
          break;
      }
    });
  });

  // Loop de renderizaÃ§Ã£o
  const start = async () => {
    await mindarThree.start();
    renderer.setAnimationLoop(() => {
      orbitControls.update();
      renderer.render(scene, camera);
    });
  };
  start();
});
