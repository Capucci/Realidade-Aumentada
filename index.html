<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Simulado com TransformControls</title>
  <style>
    body { margin:0; overflow:hidden; }
    #info { position:absolute; top:10px; left:10px; color:white; background:rgba(0,0,0,0.5); padding:8px; font-family:sans-serif; z-index:10; }
  </style>
</head>
<body>
<div id="info">
  Teclas: 1=Mover | 2=Rotacionar | 3=Escalar
</div>

<!-- Three.js -->
<script src="https://unpkg.com/three@0.150.0/build/three.min.js"></script>
<!-- Loaders e Controls -->
<script src="https://unpkg.com/three@0.150.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://unpkg.com/three@0.150.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://unpkg.com/three@0.150.0/examples/js/controls/TransformControls.js"></script>
<!-- MindAR -->
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"></script>

<script>
window.addEventListener('load', async () => {
  const mindAR = new window.MindARThree.MindARThree({
    container: document.body,
    imageTargetSrc: './targets.mind'
  });

  const { renderer, scene, camera } = mindAR;

  // Luz
  const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
  scene.add(light);

  // Anchor real do target
  const anchor = mindAR.addAnchor(0);

  // OrbitControls
  const orbitControls = new THREE.OrbitControls(camera, renderer.domElement);
  orbitControls.enableDamping = true;

  // Carregar modelo GLB
  const loader = new THREE.GLTFLoader();
  loader.load('./model.glb', (gltf) => {
    const model = gltf.scene;
    model.scale.set(0.2,0.2,0.2);
    model.position.set(0,0,0);

    // Adiciona ao anchor real
    anchor.group.add(model);

    // Preview AR simulado
    const previewModel = model.clone();
    previewModel.position.set(0,0,-1); // 1 metro na frente da câmera
    scene.add(previewModel);

    // TransformControls
    const transformControls = new THREE.TransformControls(camera, renderer.domElement);
    transformControls.attach(previewModel);
    scene.add(transformControls);

    // Bloqueia OrbitControls durante manipulação
    transformControls.addEventListener('dragging-changed', (event) => {
      orbitControls.enabled = !event.value;
    });

    // Alterna modo: 1=translate, 2=rotate, 3=scale
    window.addEventListener('keydown', (event) => {
      switch(event.key){
        case "1": transformControls.setMode('translate'); break;
        case "2": transformControls.setMode('rotate'); break;
        case "3": transformControls.setMode('scale'); break;
      }
    });

    // Log automático de posição/rotacao/escala
    transformControls.addEventListener('objectChange', () => {
      console.log('Position:', previewModel.position);
      console.log('Rotation (rad):', previewModel.rotation);
      console.log('Scale:', previewModel.scale);
    });
  });

  // Start AR
  await mindAR.start();

  // Render loop
  renderer.setAnimationLoop(() => {
    orbitControls.update();
    renderer.render(scene, camera);
  });
});
</script>
</body>
</html>
